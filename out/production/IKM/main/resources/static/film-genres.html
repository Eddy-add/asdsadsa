<!doctype html>
<html lang="ru">
<head>
    <link rel="stylesheet" href="/style.css">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Связи фильм-жанр</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 24px; }
        nav a { margin-right: 12px; }
        h1 { margin: 12px 0; }
        .row { display:flex; gap:12px; flex-wrap:wrap; margin: 10px 0; }
        select, button { padding: 8px; }
        table { border-collapse: collapse; width: 100%; margin-top: 12px; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background: #f5f5f5; }
        .actions { white-space: nowrap; }
        .muted { color: #666; font-size: 12px; }
    </style>
</head>
<body>
<nav>
    <a href="/">Фильмы</a>
    <a href="/genres.html">Жанры</a>
    <a href="/film-genres.html">Связи</a>
</nav>

<h1>Связи фильм ↔ жанр</h1>
<div class="muted">REST: <code>/api/film-genres</code></div>

<h3 id="formTitle">Добавить связь</h3>
<div class="row">
    <select id="filmSelect"></select>
    <select id="genreSelect"></select>
</div>
<div class="row">
    <button id="saveBtn">Сохранить</button>
    <button id="cancelBtn" style="display:none;">Отмена</button>
</div>

<h3>Список связей</h3>
<table>
    <thead>
    <tr>
        <th>№</th>
        <th>Фильм</th>
        <th>Жанр</th>
        <th class="actions">Действия</th>
    </tr>
    </thead>
    <tbody id="tbody"></tbody>
</table>

<script>
    const api = "/api/film-genres";
    const filmsApi = "/api/films";
    const genresApi = "/api/genres";

    let editOld = null; // {filmId, genreId}

    const el = (id) => document.getElementById(id);

    async function loadSelects() {
      const films = await (await fetch(filmsApi)).json();
      const genres = await (await fetch(genresApi)).json();

      const filmSel = el("filmSelect");
      const genreSel = el("genreSelect");

      filmSel.innerHTML = films
        .sort((a,b)=> (a.id??0)-(b.id??0))
        .map(f => `<option value="${f.id}">${escapeHtml(f.title ?? ("#" + f.id))}</option>`)
        .join("");

      genreSel.innerHTML = genres
        .sort((a,b)=> (a.id??0)-(b.id??0))
        .map(g => `<option value="${g.id}">${escapeHtml(g.name ?? ("#" + g.id))}</option>`)
        .join("");
    }

    function resetForm() {
      editOld = null;
      el("formTitle").innerText = "Добавить связь";
      el("cancelBtn").style.display = "none";
    }

    function readForm() {
      return {
        filmId: Number(el("filmSelect").value),
        genreId: Number(el("genreSelect").value),
      };
    }

    async function loadLinks() {
      const res = await fetch(api);
      const links = await res.json();

      const tbody = el("tbody");
      tbody.innerHTML = "";

      links.forEach((x, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${escapeHtml(x.filmTitle)}</td>
          <td>${escapeHtml(x.genreName)}</td>
          <td class="actions">
            <button data-edit="${x.filmId}:${x.genreId}">Редактировать</button>
            <button data-del="${x.filmId}:${x.genreId}">Удалить</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll("button[data-del]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const [filmId, genreId] = btn.getAttribute("data-del").split(":").map(Number);
          if (!confirm("Удалить эту связь?")) return;

          const r = await fetch(`${api}/${filmId}/${genreId}`, { method: "DELETE" });
          if (!r.ok) alert("Ошибка удаления:\n" + await r.text());
          await loadLinks();
        });
      });

      tbody.querySelectorAll("button[data-edit]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const [filmId, genreId] = btn.getAttribute("data-edit").split(":").map(Number);
          editOld = { filmId, genreId };

          el("filmSelect").value = String(filmId);
          el("genreSelect").value = String(genreId);

          el("formTitle").innerText = "Редактировать связь";
          el("cancelBtn").style.display = "inline-block";
          window.scrollTo({ top: 0, behavior: "smooth" });
        });
      });
    }

    async function save() {
      const body = readForm();

      const method = editOld ? "PUT" : "POST";
      const url = editOld ? `${api}/${editOld.filmId}/${editOld.genreId}` : api;

      const res = await fetch(url, {
        method,
        headers: { "Content-Type": "application/json; charset=utf-8" },
        body: JSON.stringify(body)
      });

      if (!res.ok) {
        alert("Ошибка сохранения:\n" + await res.text());
        return;
      }

      resetForm();
      await loadLinks();
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    el("saveBtn").addEventListener("click", save);
    el("cancelBtn").addEventListener("click", resetForm);

    (async () => {
      await loadSelects();
      await loadLinks();
    })();
</script>
</body>
</html>
