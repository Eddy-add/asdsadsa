<!doctype html>
<html lang="ru">
<head>
    <link rel="stylesheet" href="/style.css">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Movie Catalog</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 24px; }
        nav a { margin-right: 12px; }
        h1 { margin: 12px 0; }
        .row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px; align-items: center; }
        input { padding: 8px; min-width: 220px; }
        button { padding: 8px 12px; cursor: pointer; }
        table { border-collapse: collapse; width: 100%; margin-top: 12px; }
        th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
        th { background: #f5f5f5; }
        .actions { white-space: nowrap; }
        .muted { color: #666; font-size: 12px; }
        .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius: 999px; margin: 2px 6px 2px 0; font-size: 12px; }

        /* modal */
        .backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.35); display:none; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); width: min(640px, 92vw);
                 background: #fff; border-radius: 8px; padding: 16px; display:none; border: 1px solid #ddd; }
        .modal h3 { margin: 0 0 12px 0; }
        .grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 8px; max-height: 45vh; overflow:auto; padding: 8px; border: 1px solid #eee; }
        .modal .row { justify-content: flex-end; margin-top: 12px; }
        label { display:flex; gap: 8px; align-items:center; }
    </style>
</head>
<body>
<nav>
    <a href="/">Фильмы</a>
    <a href="/genres.html">Жанры</a>
    <a href="/actors.html">Актёры</a>
</nav>

<h1>Каталог фильмов</h1>
<div class="muted">REST: <code>/api/films</code></div>

<h3 id="formTitle">Добавить фильм</h3>

<div class="row">
    <input id="title" placeholder="Название" />
    <input id="releaseYear" placeholder="Год" type="number" min="1888" max="2100" />
    <input id="runtimeMin" placeholder="Длительность (мин)" type="number" min="1" max="1000" />
    <input id="description" placeholder="Описание" style="min-width: 360px;" />
</div>

<div class="row">
    <button id="saveBtn">Сохранить</button>
    <button id="cancelBtn" style="display:none;">Отмена</button>
</div>

<h3>Фильмы</h3>
<table>
    <thead>
    <tr>
        <th>№</th>
        <th>Название</th>
        <th>Год</th>
        <th>Мин</th>
        <th>Жанры</th>
        <th>Описание</th>
        <th class="actions">Действия</th>
    </tr>
    </thead>
    <tbody id="tbody"></tbody>
</table>

<div class="backdrop" id="backdrop"></div>
<div class="modal" id="genreModal">
    <h3 id="genreTitle">Жанры фильма</h3>
    <div class="muted" style="margin-bottom:8px;">Выбери жанры и нажми “Сохранить”.</div>
    <div class="grid" id="genreGrid"></div>
    <div class="row">
        <button id="genreSaveBtn">Сохранить</button>
        <button id="genreCancelBtn">Отмена</button>
    </div>
</div>

<script>
    const filmsApi = "/api/films";
    const genresApi = "/api/genres";

    let editId = null;

    let allGenres = [];
    let modalFilmId = null;

    const el = (id) => document.getElementById(id);

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function readForm() {
      return {
        title: el("title").value.trim(),
        releaseYear: el("releaseYear").value ? Number(el("releaseYear").value) : null,
        runtimeMin: el("runtimeMin").value ? Number(el("runtimeMin").value) : null,
        description: el("description").value.trim()
      };
    }

    function fillForm(f) {
      el("title").value = f.title ?? "";
      el("releaseYear").value = f.releaseYear ?? "";
      el("runtimeMin").value = f.runtimeMin ?? "";
      el("description").value = f.description ?? "";
    }

    function resetForm() {
      editId = null;
      fillForm({ title:"", releaseYear:"", runtimeMin:"", description:"" });
      el("formTitle").innerText = "Добавить фильм";
      el("cancelBtn").style.display = "none";
    }

    async function loadAllGenres() {
      const res = await fetch(genresApi);
      allGenres = await res.json();
      allGenres.sort((a,b) => String(a.name).localeCompare(String(b.name), "ru"));
    }

    function renderGenresPills(genres) {
      if (!genres || genres.length === 0) return '<span class="muted">—</span>';
      return genres.map(g => `<span class="pill">${escapeHtml(g.name)}</span>`).join("");
    }

    async function loadFilms() {
      const res = await fetch(filmsApi);
      const films = await res.json();

      const tbody = el("tbody");
      tbody.innerHTML = "";

      films.forEach((f, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${escapeHtml(f.title)}</td>
          <td>${escapeHtml(f.releaseYear)}</td>
          <td>${escapeHtml(f.runtimeMin)}</td>
          <td>${renderGenresPills(f.genres)}</td>
          <td>${escapeHtml(f.description)}</td>
          <td class="actions">
            <button data-genres="${f.id}">Жанры</button>
            <button data-edit="${f.id}">Редактировать</button>
            <button data-del="${f.id}">Удалить</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll("button[data-edit]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-edit");
          const film = await (await fetch(`${filmsApi}/${id}`)).json();
          editId = film.id;
          fillForm(film);
          el("formTitle").innerText = "Редактировать фильм";
          el("cancelBtn").style.display = "inline-block";
          window.scrollTo({ top: 0, behavior: "smooth" });
        });
      });

      tbody.querySelectorAll("button[data-del]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-del");
          if (!confirm("Удалить фильм?")) return;

          const res = await fetch(`${filmsApi}/${id}`, { method: "DELETE" });
          if (!res.ok) {
            alert("Ошибка удаления:\n" + await res.text());
            return;
          }
          await loadFilms();
        });
      });

      tbody.querySelectorAll("button[data-genres]").forEach(btn => {
        btn.addEventListener("click", async () => {
          modalFilmId = Number(btn.getAttribute("data-genres"));
          await openGenresModal(modalFilmId);
        });
      });
    }

    async function saveFilm() {
      const film = readForm();

      if (!film.title) { alert("Название обязательно"); return; }
      if (film.releaseYear !== null && (film.releaseYear < 1888 || film.releaseYear > 2100)) {
        alert("Год должен быть от 1888 до 2100"); return;
      }
      if (film.runtimeMin !== null && film.runtimeMin <= 0) {
        alert("Длительность должна быть > 0"); return;
      }

      const method = editId ? "PUT" : "POST";
      const url = editId ? `${filmsApi}/${editId}` : filmsApi;

      const res = await fetch(url, {
        method,
        headers: { "Content-Type": "application/json; charset=utf-8" },
        body: JSON.stringify(film)
      });

      if (!res.ok) {
        alert("Ошибка сохранения:\n" + await res.text());
        return;
      }

      resetForm();
      await loadFilms();
    }

    // ===== modal genres =====

    function showModal(show) {
      el("backdrop").style.display = show ? "block" : "none";
      el("genreModal").style.display = show ? "block" : "none";
    }

    async function openGenresModal(filmId) {
      const film = await (await fetch(`${filmsApi}/${filmId}`)).json();
      const current = new Set((film.genres ?? []).map(g => Number(g.id)));

      el("genreTitle").innerText = `Жанры: ${film.title}`;

      const grid = el("genreGrid");
      grid.innerHTML = "";

      allGenres.forEach(g => {
        const id = Number(g.id);
        const checked = current.has(id) ? "checked" : "";
        const item = document.createElement("div");
        item.innerHTML = `
          <label>
            <input type="checkbox" data-genre-id="${id}" ${checked}/>
            <span>${escapeHtml(g.name)}</span>
          </label>
        `;
        grid.appendChild(item);
      });

      showModal(true);
    }

    async function saveFilmGenres() {
      const ids = Array.from(document.querySelectorAll('#genreGrid input[type="checkbox"]'))
        .filter(ch => ch.checked)
        .map(ch => Number(ch.getAttribute("data-genre-id")));

      const res = await fetch(`${filmsApi}/${modalFilmId}/genres`, {
        method: "PUT",
        headers: { "Content-Type": "application/json; charset=utf-8" },
        body: JSON.stringify(ids)
      });

      if (!res.ok) {
        alert("Ошибка сохранения жанров:\n" + await res.text());
        return;
      }

      showModal(false);
      await loadFilms();
    }

    // init
    el("saveBtn").addEventListener("click", saveFilm);
    el("cancelBtn").addEventListener("click", resetForm);

    el("genreSaveBtn").addEventListener("click", saveFilmGenres);
    el("genreCancelBtn").addEventListener("click", () => showModal(false));
    el("backdrop").addEventListener("click", () => showModal(false));

    (async () => {
      await loadAllGenres();
      await loadFilms();
    })();
</script>
</body>
</html>
