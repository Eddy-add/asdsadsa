<!doctype html>
<html lang="ru">
<head>
  <link rel="stylesheet" href="/style.css">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Жанры</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    nav a { margin-right: 12px; }
    h1 { margin: 12px 0; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px; }
    input { padding: 8px; min-width: 260px; }
    button { padding: 8px 12px; cursor: pointer; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
    th { background: #f5f5f5; }
    .actions { white-space: nowrap; }
    .muted { color: #666; font-size: 12px; }
  </style>
</head>
<body>
<nav>
  <a href="/">Фильмы</a>
  <a href="/genres.html">Жанры</a>
  <a href="/actors.html">Актёры</a>
</nav>

<h1>Жанры</h1>
<div class="muted">REST: <code>/api/genres</code></div>

<h3 id="formTitle">Добавить жанр</h3>
<div class="row">
  <input id="name" placeholder="Название жанра" />
</div>
<div class="row">
  <button id="saveBtn">Сохранить</button>
  <button id="cancelBtn" style="display:none;">Отмена</button>
</div>

<h3>Список жанров</h3>
<table>
  <thead>
  <tr>
    <th>№</th>
    <th>Название</th>
    <th class="actions">Действия</th>
  </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>

<script>
  const api = "/api/genres";
  let editId = null;

  const el = (id) => document.getElementById(id);

  function readForm() {
    return { name: el("name").value.trim() };
  }

  function fillForm(genre) {
    el("name").value = genre.name ?? "";
  }

  function resetForm() {
    editId = null;
    fillForm({ name: "" });
    el("formTitle").innerText = "Добавить жанр";
    el("cancelBtn").style.display = "none";
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  async function loadGenres() {
    const res = await fetch(api);
    if (!res.ok) {
      const text = await res.text();
      alert("Ошибка загрузки жанров:\n" + text);
      return;
    }

    const genres = await res.json();

    // стабильный порядок
    genres.sort((a, b) => (a.id ?? 0) - (b.id ?? 0));

    const tbody = el("tbody");
    tbody.innerHTML = "";

    genres.forEach((g, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${escapeHtml(g.name ?? "")}</td>
        <td class="actions">
          <button data-edit="${g.id}">Редактировать</button>
          <button data-del="${g.id}">Удалить</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll("button[data-edit]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-edit");
        const r = await fetch(`${api}/${id}`);
        if (!r.ok) {
          const text = await r.text();
          alert("Ошибка получения жанра:\n" + text);
          return;
        }
        const genre = await r.json();

        editId = genre.id;
        fillForm(genre);
        el("formTitle").innerText = `Редактировать жанр`;
        el("cancelBtn").style.display = "inline-block";
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    });

    tbody.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-del");
        if (!confirm(`Удалить жанр?`)) return;

        const r = await fetch(`${api}/${id}`, { method: "DELETE" });
        if (!r.ok) {
          const text = await r.text();
          alert("Ошибка удаления:\n" + text);
          return;
        }
        await loadGenres();
      });
    });
  }

  async function save() {
    const genre = readForm();

    if (!genre.name) {
      alert("Название жанра обязательно");
      return;
    }

    const method = editId ? "PUT" : "POST";
    const url = editId ? `${api}/${editId}` : api;

    const res = await fetch(url, {
      method,
      headers: { "Content-Type": "application/json; charset=utf-8" },
      body: JSON.stringify(genre)
    });

    if (!res.ok) {
      const text = await res.text();
      alert("Ошибка сохранения:\n" + text);
      return;
    }

    resetForm();
    await loadGenres();
  }

  el("saveBtn").addEventListener("click", save);
  el("cancelBtn").addEventListener("click", resetForm);

  loadGenres();
</script>
</body>
</html>
