<!doctype html>
<html lang="ru">
<head>
  <link rel="stylesheet" href="/style.css">
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Актёры</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    nav a { margin-right: 12px; }
    h1 { margin: 12px 0; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px; align-items: center; }
    input, textarea, select { padding: 8px; }
    input { min-width: 260px; }
    textarea { min-width: 520px; min-height: 72px; }
    select { min-width: 520px; }
    button { padding: 8px 12px; cursor: pointer; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
    th { background: #f5f5f5; }
    .actions { white-space: nowrap; }
    .muted { color: #666; font-size: 12px; }
    .photo { width: 44px; height: 44px; object-fit: cover; border-radius: 6px; border: 1px solid #ddd; }
    .name { font-weight: 700; }
    .chip { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; margin:2px 6px 2px 0; font-size:12px; }
  </style>
</head>
<body>

<nav>
  <a href="/">Фильмы</a>
  <a href="/genres.html">Жанры</a>
  <a href="/actors.html">Актёры</a>
</nav>

<h1>Актёры</h1>
<div class="muted">REST: <code>/api/actors</code></div>

<div class="row">
  <input id="q" placeholder="Поиск по имени..."/>
  <button id="clearSearchBtn">Сброс</button>
</div>

<h3 id="formTitle">Добавить актёра</h3>

<div class="row">
  <input id="fullName" placeholder="ФИО"/>
  <input id="birthYear" type="number" placeholder="Год рождения"/>
  <input id="country" placeholder="Страна"/>
</div>

<div class="row">
  <input id="photoUrl" style="min-width:520px" placeholder="Ссылка на фото (URL)"/>
</div>

<div class="row" style="flex-direction:column; align-items:flex-start;">
  <div class="muted">Фильмы (можно выбрать несколько)</div>
  <select id="filmIds" multiple size="8"></select>
  <div class="muted">Подсказка: удерживай <b>Ctrl</b> (или <b>Cmd</b> на Mac), чтобы выделять
    несколько
  </div>
</div>

<div class="row">
  <button id="saveBtn">Сохранить</button>
  <button id="cancelBtn" style="display:none;">Отмена</button>
</div>

<h3>Список актёров</h3>

<table>
  <thead>
  <tr>
    <th>№</th>
    <th>Имя</th>
    <th>Год</th>
    <th>Страна</th>
    <th>Фото</th>
    <th>Фильмы</th>
    <th class="actions">Действия</th>
  </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>

<script>
  const actorsApi = "/api/actors";
  const filmsApi = "/api/films";

  let editId = null;
  let lastLoadedActors = [];
  let allFilms = [];

  const el = (id) => document.getElementById(id);

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function getSelectedFilmIds() {
    const sel = el("filmIds");
    return Array.from(sel.selectedOptions).map(o => Number(o.value));
  }

  function setSelectedFilmIds(ids) {
    const set = new Set((ids ?? []).map(Number));
    const sel = el("filmIds");
    Array.from(sel.options).forEach(o => { o.selected = set.has(Number(o.value)); });
  }

  function readForm() {
    const fullName = el("fullName").value.trim();
    const birthYearRaw = el("birthYear").value.trim();
    const country = el("country").value.trim();
    const photoUrl = el("photoUrl").value.trim();
    const birthYear = birthYearRaw === "" ? null : Number(birthYearRaw);

    return {
      fullName,
      birthYear,
      country,
      photoUrl,
      filmIds: getSelectedFilmIds()
    };
  }

  function fillForm(a) {
    el("fullName").value = a.fullName ?? "";
    el("birthYear").value = (a.birthYear ?? "") === null ? "" : (a.birthYear ?? "");
    el("country").value = a.country ?? "";
    el("photoUrl").value = a.photoUrl ?? "";

    // поддерживаем оба варианта (filmIds или films[])
    if (Array.isArray(a.filmIds)) setSelectedFilmIds(a.filmIds);
    else if (Array.isArray(a.films)) setSelectedFilmIds(a.films.map(f => f.id));
    else setSelectedFilmIds([]);
  }

  function resetForm() {
    editId = null;
    fillForm({ fullName:"", birthYear:null, country:"", photoUrl:"", filmIds:[] });
    el("formTitle").innerText = "Добавить актёра";
    el("cancelBtn").style.display = "none";
  }

  function renderActors(list) {
    const q = el("q").value.trim().toLowerCase();
    const filtered = q
      ? list.filter(a => String(a.fullName ?? "").toLowerCase().includes(q))
      : list;

    const tbody = el("tbody");
    tbody.innerHTML = "";

    filtered.forEach((a, idx) => {
      const year = a.birthYear ?? "—";
      const country = a.country ?? "—";
      const photoUrl = (a.photoUrl ?? "").trim();

      const films = Array.isArray(a.films) ? a.films : [];
      const filmsHtml = films.length
        ? films.map(f => `<span class="chip">${escapeHtml(f.title ?? "")}${f.releaseYear ? " ("+escapeHtml(f.releaseYear)+")" : ""}</span>`).join("")
        : `<span class="muted">—</span>`;

      const photoCell = photoUrl
        ? `<img class="photo" src="${escapeHtml(photoUrl)}" alt="photo" onerror="this.style.display='none'">`
        : "";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td class="name">${escapeHtml(a.fullName ?? "")}</td>
        <td>${escapeHtml(year)}</td>
        <td>${escapeHtml(country)}</td>
        <td>${photoCell}</td>
        <td>${filmsHtml}</td>
        <td class="actions">
          <button data-edit="${a.id}">Редактировать</button>
          <button data-del="${a.id}">Удалить</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll("button[data-edit]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-edit");
        const res = await fetch(`${actorsApi}/${id}`);
        const actor = await res.json();

        editId = actor.id;
        fillForm(actor);
        el("formTitle").innerText = `Редактировать актёра`;
        el("cancelBtn").style.display = "inline-block";
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    });

    tbody.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-del");
        if (!confirm("Удалить актёра?")) return;

        const res = await fetch(`${actorsApi}/${id}`, { method: "DELETE" });
        if (!res.ok) {
          const text = await res.text();
          alert("Ошибка удаления:\n" + text);
          return;
        }
        await loadActors();
      });
    });
  }

  async function loadFilms() {
    const res = await fetch(filmsApi);
    if (!res.ok) {
      const text = await res.text();
      alert("Не удалось загрузить фильмы (/api/films):\n" + text);
      return;
    }
    allFilms = await res.json();
    allFilms.sort((a,b) => String(a.title ?? "").localeCompare(String(b.title ?? ""), "ru"));

    const sel = el("filmIds");
    sel.innerHTML = "";
    for (const f of allFilms) {
      const opt = document.createElement("option");
      opt.value = f.id;
      const year = f.releaseYear ? ` (${f.releaseYear})` : "";
      opt.textContent = `${f.title ?? "Без названия"}${year}`;
      sel.appendChild(opt);
    }
  }

  async function loadActors() {
    const res = await fetch(actorsApi);
    if (!res.ok) {
      const text = await res.text();
      alert("Ошибка загрузки актёров:\n" + text);
      return;
    }
    lastLoadedActors = await res.json();
    lastLoadedActors.sort((a,b) => String(a.fullName ?? "").localeCompare(String(b.fullName ?? ""), "ru"));
    renderActors(lastLoadedActors);
  }

  async function save() {
    const actor = readForm();

    if (!actor.fullName) {
      alert("ФИО обязательно");
      return;
    }
    if (actor.birthYear !== null && (Number.isNaN(actor.birthYear) || actor.birthYear < 1850 || actor.birthYear > 2100)) {
      alert("Год рождения выглядит неправильно");
      return;
    }

    const method = editId ? "PUT" : "POST";
    const url = editId ? `${actorsApi}/${editId}` : actorsApi;

    const res = await fetch(url, {
      method,
      headers: { "Content-Type": "application/json; charset=utf-8" },
      body: JSON.stringify(actor)
    });

    if (!res.ok) {
      const text = await res.text();
      alert("Ошибка сохранения:\n" + text);
      return;
    }

    resetForm();
    await loadActors();
  }

  el("saveBtn").addEventListener("click", save);
  el("cancelBtn").addEventListener("click", resetForm);

  el("q").addEventListener("input", () => renderActors(lastLoadedActors));
  el("clearSearchBtn").addEventListener("click", () => {
    el("q").value = "";
    renderActors(lastLoadedActors);
  });

  (async () => {
    await loadFilms();
    await loadActors();
  })();
</script>
</body>
</html>
